<%- include('../userlayout/header.ejs')%>

    <link href="/usercss/style.css" rel="stylesheet">

    <body class="animsition">
        <div class="top-bar">
            <div class="content-topbar flex-sb-m h-full container">
                <div class="left-top-bar">
                    Free shipping for standard order over $100
                </div>

                <div class="right-top-bar flex-w h-full">

                    <a href="/login" class="flex-c-m trans-04 p-lr-25">
                        Login
                    </a>

                    <a href="/profile" class="flex-c-m trans-04 p-lr-25">
                        Profile
                    </a>
                    <a href="/orderview" class="flex-c-m trans-04 p-lr-25">
                        Your Orders
                    </a>
                    <a href="/logout" class="flex-c-m trans-04 p-lr-25">
                        LogOut
                    </a>
                </div>
            </div>


            <div class="wrap-menu-desktop">
                <nav class="limiter-menu-desktop container">

                    <!-- Logo desktop -->
                    <h3 style="margin-right: 50px">Book Of Books</h3>

                    <!-- Menu desktop -->
                    <div class="menu-desktop">
                        <ul class="main-menu">
                            <li class="active-menu">
                                <a href="/">Home</a>
                            </li>

                            <li>
                                <a href="/shop">Shop</a>
                            </li>

                            <li class="label1" data-label1="hot">
                                <a href="/Cart">Features</a>
                            </li>

                            <li>
                                <a href="/blog">Blog</a>
                            </li>

                            <li>
                                <a href="/About">About</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Header Mobile -->
        <div class="wrap-header-mobile">
            <!-- Logo moblie -->
            <div class="logo-mobile">
                <h3 style="margin-right: 50px">Book Of Books</h3>
            </div>

            <!-- Icon header -->
            <div class="wrap-icon-header flex-w flex-r-m m-r-15">
                <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 js-show-modal-search">
                    <i class="zmdi zmdi-search"></i>
                </div>

                <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti js-show-cart"
                    data-notify="2">
                    <i class="zmdi zmdi-shopping-cart"></i>
                </div>

                <a href="#" class="dis-block icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti"
                    data-notify="0">
                    <i class="zmdi zmdi-favorite-outline"></i>
                </a>
            </div>

            <!-- Button show menu -->
            <div class="btn-show-menu-mobile hamburger hamburger--squeeze">
                <span class="hamburger-box">
                    <span class="hamburger-inner"></span>
                </span>
            </div>
        </div>




        <!-- Modal Search -->
        <div class="modal-search-header flex-c-m trans-04 js-hide-modal-search">
            <div class="container-search-header">
                <button class="flex-c-m btn-hide-modal-search trans-04 js-hide-modal-search">
                    <img src="images/icons/icon-close2.png" alt="CLOSE">
                </button>

                <form class="wrap-search-header flex-w p-l-15">
                    <button class="flex-c-m trans-04">
                        <i class="zmdi zmdi-search"></i>
                    </button>
                    <input class="plh3" type="text" name="search" placeholder="Search...">
                </form>
            </div>
        </div>
        </header>
        <div class="container">
            <div class="main-body">

                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="main-breadcrumb" style="padding-top: 80px;">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">User Profile</li>
                    </ol>
                </nav>
                <!-- /Breadcrumb -->

                <div class="row gutters-sm" >
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin"
                                        class="rounded-circle" width="150">
                                    <div class="mt-3">
                                        <h4>
                                            <%= user.name %>
                                        </h4>
                                        <br>
                                        <input hidden type="text" id="userid" value="<%= user._id %>">
                                        <p class="text-muted font-size-sm">
                                            <%= user.mobile %>
                                        </p>
                                        <p class="text-muted font-size-sm">
                                            <%= user.email %>
                                        </p>
                                        <p class="text-muted font-size-sm">wallet Balance:<%= user.wallet %>
                                        </p>
                                        <p class="text-muted font-size-sm">referal link :</p>
                                        <p id="ref" hidden class="text-muted font-size-sm">
                                            http://localhost:3000/signup?ref=<%= user._id %>
                                        </p><button type="button" onclick="ref()" class="btn btn-light">Copy</button>
                                    </div>
                                    <br>
                                    <button type="button" class="btn btn-success ml-3" data-toggle="modal"
                                        data-target="#addnew">
                                        change password</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-8" id="reloadDiv">

                        <div class="card mb-3" id="refresh">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-3" style="padding: 15px;">
                                        <h6 class="mb-0">Full Name</h6>
                                    </div>
                                    <div class="text-muted font-size-sm" style="padding: 12.5px;">
                                        <b>
                                            <%= user.name %>
                                        </b>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3" style="padding: 15px;">
                                        <h6 class="mb-0">Email</h6>
                                    </div>
                                    <div class="text-muted font-size-sm" style="padding: 12.5px;">
                                        <b>
                                            <%= user.email %>
                                        </b>
                                    </div>
                                </div>
                                <hr>
                                <div  class="row">
                                    <div class="col-sm-3" style="padding: 15px;">
                                        <h6 class="mb-0">Phone</h6>
                                    </div>
                                    <div class="text-muted font-size-sm" style="padding: 12.5px;">
                                        <b>
                                            <%= user.mobile %>
                                        </b>
                                    </div>
                                </div>
                                <hr>
                                <% user.address.forEach((add,index)=>{ %>
                                    <div class="row " style="padding: 15px;">

                                        <div class="col-3 " >
                                            <h6 class="mb-0">Home Address: <%= index+1 %>
                                            </h6>
                                        </div>
                                        <hr>

                                        <div class="text-muted  col-5 font-size-sm">
                                            <b>
                                                <%= add.address1 %>
                                            </b>
                                        </div>
                                        <div class="col-4">
                                            <a class="btn btn-info " href="/editaddress/<%= add._id %>">Edit</a>                                           
                                                <button class="btn btn-info "
                                                    onclick="deleteAd('<%= add._id %>')">delete</button>

                                            </div>
                                            <br>

                                    </div>

                                    <% }) %>
                                        <hr>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <a class="btn btn-info " href="/ProfileEdit">Edit</a>
                                                <button type="button" class="btn btn-success ml-3" data-toggle="modal"
                                                    data-target="#addnewadress">
                                                    Add Address</button>
                                            </div>

                                        </div>
                            </div>
                        </div>
                    </div>
           
                </div>
            </div>
        </div>



        <div class="modal fade" id="addnew" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="changePasswordForm">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="oldPassword" class="form-control" name="currentPassword">
                                <div class="invalid-feedback">
                                    Please enter your current password.
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" class="form-control" name="newPassword">
                                <div class="invalid-feedback">
                                    Please enter a new password.
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="form-control" name="confirmPassword">
                                <div class="invalid-feedback">
                                    Please confirm your new password.
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning" role="alert" id="alertDiv" style="display: none;"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">change Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ADD ADDRESS -->
        <div class="modal fade" id="addnewadress" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel"> Add Address</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="myform">
                        <div class="modal-body">
                            <div class="form-group">
                                <label> Add Address</label>
                                <input type="text" id="addaddress" class="form-control" name="addaddress">
                                <div class="invalid-feedback">
                                    Please enter your Address.
                                </div>
                            </div>

                        </div>
                        <div class="alert alert-warning" role="alert" id="alertDiv" style="display: none;"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" id="submitData" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            // ADD ADDRESS
            // AJAX request
            $("#submitData").on('click', function () {
                var formData = $('#myform').serialize();
                var formData = $('#myform').serializeArray();
                console.log(formData);

                $.ajax({
                    url: "/addaddress",
                    method: "post",
                    data: {
                        addaddress: formData.find(f => f.name === 'addaddress').value
                    },
                    success: function (response) {
                        console.log(response);
                        // update the UI to reflect the changes made to the user's address
                        // for example, by showing a success message or refreshing the address list
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                        // handle the error case, for example by showing an error message
                    }
                });
            });
</script>
<script>
            // CHANGE PASSWORD
            const form = document.getElementById('changePasswordForm');
            const inputs = form.querySelectorAll('input');
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                let nullFields = false;
                for (let i = 0; i < inputs.length; i++) {
                    if (inputs[i].value === '') {
                        nullFields = true;
                        $('#alertDiv').show().html('All fields are required');
                        setTimeout(() => {
                            $('#alertDiv').fadeOut('slow');
                        }, 5000);
                        break;
                    }
                }
                if (!nullFields) {
                    const userid = document.getElementById('userid').value;
                    const oldPassword = document.getElementById('oldPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const data = {
                        userid,
                        oldPassword,
                        newPassword,
                        confirmPassword
                    };
                    $.ajax({
                        url: 'change_password',
                        data: data,
                        method: 'post',
                        success: function (response) {
                            if (response.success) {
                                $('#alertDiv')
                                    .removeClass('alert-danger')
                                    .addClass('alert-success')
                                    .show()
                                    .html('Password changed successfully');
                                setTimeout(() => {
                                    $('#alertDiv').fadeOut('slow');
                                    $('#changePassword').on('hidden.bs.modal', function () { });
                                    $('#changePassword').modal('hide');
                                }, 5000);
                            } else if (response.different) {
                                $('#alertDiv')
                                    .removeClass('alert-success')
                                    .addClass('alert-danger')
                                    .show()
                                    .html('New password is different');
                                setTimeout(() => {
                                    $('#alertDiv').fadeOut('show');
                                }, 5000);
                            } else if (response.notmatch) {
                                $('#alertDiv')
                                    .removeClass('alert-success')
                                    .addClass('alert-danger')
                                    .show()
                                    .html('Old password mismatch');
                                setTimeout(() => {
                                    $('#alertDiv').fadeOut('slow');
                                }, 5000);
                            }
                        }
                    });
                }
            });
</script>

// EDIT ADDRESS
            // DELETE ADDRESS
            <script>
            function deleteAd(id) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You wan't to delete!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'yes, delete!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/deleteaddress',
                            data: {
                                id: id
                            },
                            method: 'post',
                            success: (response) => {
                                console.log("DDDD");
                                if (response.success) {
                                    Swal.fire({
                                        title: 'deleted!',
                                        text: 'Your deleted',
                                        icon: 'success',
                                        showConfirmButton: false
                                    })
                                    $('#refresh').load('/profile #refresh')
                                    console.log(response);
                                }
                            }
                        })

                    }
                })
            }
</script>

            // REFREL COPYING
            <script>
            function copyToClipboard(text) {
                // Create a temporary input element
                const input = document.createElement('input');
                input.setAttribute('value', text);
                document.body.appendChild(input);

                // Select the text in the input element
                input.select();
                input.setSelectionRange(0, 99999); // For mobile devices

                // Copy the text to the clipboard
                document.execCommand('copy');

                // Remove the temporary input element
                document.body.removeChild(input);
            }

            function ref() {
                const text = document.getElementById('ref').innerText
                copyToClipboard(text);
            }
        </script>
        </div>
        </div>
        </div>




        <%- include('../userlayout/footer.ejs')%>
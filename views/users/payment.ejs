<%- include('../userlayout/header.ejs')%>
    <!-- Customized Bootstrap Stylesheet -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

    <body>

        <header class="header-v4">
            <!-- Header desktop -->
            <div class="container-menu-desktop">
                <!-- Topbar -->
                <div class="top-bar">
                    <div class="content-topbar flex-sb-m h-full container">
                        <div class="left-top-bar">
                            Free shipping for standard order over $100
                        </div>
        
                        <div class="right-top-bar flex-w h-full">
        
                            <a href="/login" class="flex-c-m trans-04 p-lr-25">
                                Login
                            </a>
        
                            <a href="/profile" class="flex-c-m trans-04 p-lr-25">
                                Profile
                            </a>
                            <a href="/orderview" class="flex-c-m trans-04 p-lr-25">
                                Your Orders
                            </a>
                            <a href="/logout" class="flex-c-m trans-04 p-lr-25">
                                LogOut
                            </a>
                        </div>
                    </div>
                </div>

                <div class="wrap-menu-desktop how-shadow1">
                    <nav class="limiter-menu-desktop container">

                        <!-- Logo desktop -->
                        <h3 style="margin-right: 50px">Book Of Books</h3>

                        <!-- Menu desktop -->
                        <div class="menu-desktop">
                            <ul class="main-menu">
                                <li class="active-menu">
                                    <a href="/">Home</a>
                                </li>
        
                                <li>
                                    <a href="/shop">Shop</a>
                                </li>
        
                                <li class="label1" data-label1="hot">
                                    <a href="/Cart">Features</a>
                                </li>
        
                                <li>
                                    <a href="/blog">Blog</a>
                                </li>
        
                                <li>
                                    <a href="/About">About</a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- Header Mobile -->
            <div class="wrap-header-mobile">
                <!-- Logo moblie -->
                <div class="logo-mobile">
                    <h3 style="margin-right: 50px">Book Of Books</h3>
                </div>

                <!-- Icon header -->
                <div class="wrap-icon-header flex-w flex-r-m m-r-15">
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 js-show-modal-search">
                        <i class="zmdi zmdi-search"></i>
                    </div>

                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti js-show-cart"
                        data-notify="2">
                        <i class="zmdi zmdi-shopping-cart"></i>
                    </div>

                    <a href="#" class="dis-block icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti"
                        data-notify="0">
                        <i class="zmdi zmdi-favorite-outline"></i>
                    </a>
                </div>

                <!-- Button show menu -->
                <div class="btn-show-menu-mobile hamburger hamburger--squeeze">
                    <span class="hamburger-box">
                        <span class="hamburger-inner"></span>
                    </span>
                </div>
            </div>



            <!-- Page Header Start -->
            <div class="container-fluid bg-secondary mb-5">
                <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
                    <h1 class="font-weight-semi-bold text-uppercase mb-3">Checkout</h1>
                    <div class="d-inline-flex">
                        <p class="m-0"><a href="/">Home</a></p>
                        <p class="m-0 px-2">-</p>
                        <p class="m-0">Checkout</p>
                    </div>
                </div>
            </div>
            <!-- Page Header End -->


            <!-- Checkout Start -->
            <form id="checkout" method="post">
                <div class="container-fluid pt-5" id="refresh">
                    <div class="row px-xl-5">
                        <div class="col-lg-8">
                            <div class="mb-4">
                                <h4 class="font-weight-semi-bold mb-4">Billing Address</h4>
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <label>Name</label>
                                        <input name="name" value="<%= data.name %>" class="form-control" type="text"
                                            placeholder="John">
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label>E-mail</label>
                                        <input name="email" value="<%= data.email %>" class="form-control" type="text"
                                            placeholder="example@email.com">
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label>Mobile No</label>
                                        <input name="mobile" value="<%= data.mobile %>" class="form-control" type="text"
                                            placeholder="+123 456 789">
                                    </div>
                                    <div class="col-md-6 form-group" hidden>
                                        <label>userid</label>
                                        <input name="userid" value="<%= data.id %>" class="form-control" type="text"
                                            placeholder="123 Street">
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label>Country</label>
                                        <select class="custom-select">
                                            <option selected>United States</option>
                                            <option>Afghanistan</option>
                                            <option>Albania</option>
                                            <option>Algeria</option>
                                            <option>India</option>
                                        </select>

                                    </div>
                                    
                                    <div class="col-md-6 form-group" >
                                        <label>Address</label>
                                        <select style="color: black;" class="custom-select" name="address" >
                                            <option  selected> select address </option>
                                            <% data.address.forEach((element)=>{ %> 
                                                <option value="<%= element.address1%>"><%= element.address1 %>
                                                </option> 
                                                <% }) %>
                                        </select>
                                        <button type="button" class="btn btn-light ml-3" data-toggle="modal"
                                                    data-target="#addnewadress">
                                                    Add Address</button>
                                    </div>
                                    
                                    
                                    <div class="col-md-6 form-group">
                                        <label>City</label>
                                        <input name="city" value="<%=data.city%>" class="form-control" type="text"
                                            placeholder="New York">
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label>State</label>
                                        <input value="<%= data.city %>" name="state" class="form-control" type="text"
                                            placeholder="New York">
                                    </div>
                                    <div style="margin-top: 20px;" class="flex-w flex-m m-r-20 m-tb-5">
                                        <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5"
                                            type="text" name="code" id="NAMEcode" value="" placeholder="Coupon Code">

                                        <div onclick="applycoupan('<%= data.cart.totalPrice %>',$('#NAMEcode').val())"
                                            class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                                            Apply coupon
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                        <div class="col-lg-4" >
                            <div class="card border-secondary mb-5">
                                <div class="card-header bg-secondary border-0">
                                    <h4 class="font-weight-semi-bold m-0">Order Total</h4>
                                </div>
                                <div class="card-body">
                                    <h5 class="font-weight-medium mb-3">Products</h5>
                                    <% data.cart.items.forEach((x)=>{ %>
                                        <div class="d-flex justify-content-between">
                                            <p>
                                                <%= x.product_id.name %>
                                            </p>
                                            <p>
                                                <%= x.product_id.Price %>
                                                    <p>
                                        </div>
                                        <p>Quantity<%= x.qty %>
                                        </p>
                                        <input name="pro_qty" hidden value="<%= x.qty %>">
                                        <input hidden name="sprice" value="<%= x.product_id.Price %>">
                                        <input hidden name="prod_id" value="<%= x.product_id._id %>">
                                        <%= console.log(x.qty,"klooo") %>
                                            <input name="price_qty" hidden value="<%= x.product_idtotal %>">
                                            <% }) %>
                                                <div class="card-footer border-secondary bg-transparent">
                                                    
                                                    <h5 class="font-weight-bold"> Discount <span id="coupondis"></span></h5>
                                                        <br>
                                                        
                                                    <div class="d-flex justify-content-between mt-2">
                                                        
                                                        <h5 class="font-weight-bold">Total</h5>
                                                        <h5 class="font-weight-bold"><input name="total" id="total" readonly
                                                                 value="<%= data.cart.totalPrice %>"></h5>
                                                    </div>
                                                </div>
                                </div>

                                <div class="card border-secondary mb-5">
                                    <div class="card-header bg-secondary border-0">
                                        <h4 class="font-weight-semi-bold m-0">Payment</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <div class="custom-control custom-radio">
                                                <input type="radio" class="custom-control-input" value="UPI"
                                                    name="payment" id="onlinepayment">
                                                <label class="custom-control-label" for="onlinepayment">Online
                                                    Payment</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="custom-control custom-radio">
                                                <input type="radio" class="custom-control-input" name="payment"
                                                    id="cashondelivery" value="COD">
                                                <label class="custom-control-label" for="cashondelivery">Cash On
                                                    Delivery</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="custom-control custom-radio">
                                                <input type="radio" class="custom-control-input" name="payment"
                                                    id="wallet" value="wallet">
                                                <label class="custom-control-label" for="wallet">Wallet</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-footer border-secondary bg-transparent">
                                        <button class="btn btn-lg btn-block btn-primary font-weight-bold my-3 py-3"
                                            type="submit">Place
                                            Order</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </form>

            <!-- Checkout End -->
 <!-- ADD ADDRESS -->
 <div class="modal fade" id="addnewadress" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel"
 aria-hidden="true">
 <div class="modal-dialog modal-dialog-centered" role="document">
     <div class="modal-content">
         <div class="modal-header">
             <h5 class="modal-title" id="changePasswordModalLabel"> Add Address</h5>
             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                 <span aria-hidden="true">&times;</span>
             </button>
         </div>
         <form id="myform">
             <div class="modal-body">
                 <div class="form-group">
                     <label> Add Address</label>
                     <input type="text" id="addaddress" class="form-control" name="addaddress">
                     <div class="invalid-feedback">
                         Please enter your Address.
                     </div>
                 </div>

             </div>
             <div class="alert alert-warning" role="alert" id="alertDiv" style="display: none;"></div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                 <button type="submit" id="submitData" class="btn btn-primary">Save Changes</button>
             </div>
         </form>
     </div>
 </div>
</div>


            <script>
                $("#checkout").submit((e) => {
                    e.preventDefault()
                    $.ajax({
                        url: '/check_out',
                        method: 'POST',
                        data: $('#checkout').serialize(),
                        success: (response) => {
                          console.log(response)
                            if (response.status) {
                                location.href = '/success_page'
                            }else if(response.viewRazorpay){
                                razorpayPayment(response.order)
                            } else if (response.address) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'address is required',
                            })
                            }else if (response.payment) {
                                Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'select payment type',
                            })
                        }else if(response.insufficient){
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Insufficient Balence In Your Wallet',
                            })
                    }

                    }
                })
            })
                // RAZORPAY 
                function razorpayPayment(usoder) {
console.log("keriyoo")
                    var options = {
                        "key": "rzp_test_sut3OwzcuolyZv", // Enter the Key ID generated from the Dashboard
                        "amount": usoder.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                        "currency": "INR",
                        "name": "Book Of BOOK", //your business name
                        "description": "Test Transaction",
                        "image": "",
                        "order_id": usoder.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                        "handler": function (response) {
                            // alert(response.razorpay_payment_id);
                            // alert(response.razorpay_order_id);
                            // alert(response.razorpay_signature)

                            verifyPayment(response, usoder)
                        },
                        "prefill": {
                            "name": "Fadhil", //your customer's name
                            "email": "fadhil@gmail.com",
                            "contact": "1233212321"
                        },
                        "notes": {
                            "address": "Razorpay Corporate Office"
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    var rzp1 = new Razorpay(options);
                    rzp1.open();

                }
                function verifyPayment(payment, usoder) {
                    $.ajax({
                        url: '/verifypayment',
                        data: {
                            payment,
                            usoder
                        },
                        method: "POST",
                        success: (response) => {
                            console.log("doneeeeee")
                            if (response.status) {
                                location.href = '/success_page'
                            }
                        }
                    })
                }

            </script>
            <!-- COUPAN ajax -->
            <script>
                function applycoupan(total, code) {
                    $.ajax({
                        url: '/apply_coupan',
                        data: {
                            total: total,
                            code: code
                        },
                        method: "post",
                        success: (response) => {
                            console.log(response);
                        if (response.finalnot) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Buy more to access this offer.',
                            })


                        } else if (response.used) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Offer already accessed.',
                            })

                        }
                        else if (response.dateexpr) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Coupon expired.',
                            })

                        } else if (response.final) {
                            console.log("frfrfr");
console.log(response.Code,"rahul")
console.log(response.totalPrice,"rsfwgwrgergrl")
                       
                             document.getElementById('NAMEcode').value = response.Code
                             document.getElementById('coupondis').innerHTML = response.Discount
                            // document.getElementById('discount').innerHTML = response.discount
                            // document.getElementById('discount1').value = response.discount
                            // document.getElementById('total').innerHTML = response.totalPrice
                            document.getElementById('total').value = response.totalPrice

                            Swal.fire(
                                'Good job!',
                                'Coupen granted!',
                                'success'
                            )
                        } else if (response.invalid) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Invalid coupon.',
                            })


                        }
                    }
                })
            }
            </script>
<script>
 // ADD ADDRESS
            // AJAX request
            $("#submitData").on('click', function () {
                var formData = $('#myform').serialize();
                var formData = $('#myform').serializeArray();
                console.log(formData);

                $.ajax({
                    url: "/adreesstocheckout",
                    method: "post",
                    data: {
                        addaddress: formData.find(f => f.name === 'addaddress').value
                    },
                    success: function (response) {
                        console.log(response);
                        // update the UI to reflect the changes made to the user's address
                        // for example, by showing a success message or refreshing the address list
                        $('#refresh').load('/checkout #refresh')
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                        // handle the error case, for example by showing an error message
                    }
                });
            });
</script>





            <%- include('../userlayout/footer.ejs')%>